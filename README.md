技术报告说明 

 

预期目标和全文结构 

初期实验目标为针对采购价格这一项的检测，最终结果是对价格的异常可能性进行评价。最终您将得到四个输出文件夹/RFD，/MR，/AE，/Output。整合的最终结果请在/Output中查看。 

实验部分整体上将完成三项内容：①通过数据集的训练得到不同的模型；②通过模型计算出任意输入交易信息的预测采购价格；③对预测价格和实际价格进行比较，得出异常分数，异常分数越高，越有可能是异常交易信息。 

本文结构如下：第二部分将说明代码的运行环境和需要引用的库信息以及安装指南。第三部分将具体介绍代码的使用教程和输入的训练数据的需求以及预期的输出结果。第四部分将对结果分析进行更详细地阐释，期望协助理解异常分数的计算和模型准确率。第五部分为现阶段完善模型的需求。第六部分是补充建议/未来计划的建议。 

 

 

 

使用准备 

该部分内容将说明代码的运行环境和需要引用的库信息以及安装指南，如果已经配置，请跳过此步骤。 

本实验将使用python3.0以上的环境，如果您使用的是windows系统，请打开命令台输入pip --verison 查看python版本，是否有pip功能。 

如果没有，请输入curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py 进行下载 

之后，请继续在命令行下载以下库 

sklearn：pip install scikit-learn  

keras: pip install –upgrade tensorflow 

其余库numpy, pandas, statsmodels, random, xlrd, os, lightgbm, matplotlib, xlsxwriter  

请按 pip3 install 库名(如：numpy)的格式进行安装  

如果库版本过旧，可以使用pip install -U 库名(如：pip) 的格式进行更新。  

 

 

 

代码执行说明 

  

        执行代码时，请跳转到main.py文件界面进行运行，main函数将调用其他所有文件。 

 

在初次运行前，请将原始的文件移动至main.py同目录下，或者修改main中的数据读取路径 line 10：pathway=‘文件的路径’ 

 

文件格式上请务必和样例数据保持统一。您的初始文件(训练数据)需要包括目录和交易两栏，后续预测的数据（验证集和测试集）可以不包含。同时，请尽量保证交易中的药品在目录栏中有对应的挂网价格，如果没有，我们会自行计算现有交易的类中心作为参考价格。 

 

建议： 

 

①首先使用同一种药品名的数据，数据大小不限； 

②使用不同药品名称的数据进行预测，行数请保持在1w上下； 

③若以上两步均没有出现代码运行问题，且时间较短（3分钟以内），请尝试投喂大量数据进行拟合。 

 

以下是对main函数的说明，请根据需要调度您所需要的函数： 

 

Main函数部分会首先对原始数据集进行预处理工作，路径默认为同路径下的“data.xlsx”文件，参考line 14-25，此处有两个任务，一个是将数据中的采购价格进行记录，作为后续归一化的参照。另一个是对原始数据集进行筛选和拼接。  

筛选的具体内容请参考preprocessing的dataconnection部分(line 113)  

由于我们的去敏数据集进行了微调，请确认您运行时以下代码应为如下所示： 

# 输入文件路径 

  

pathway_0 = './样例数据.xlsx' 

  

# 得到预处理后的西药和中药dataframe以及挂网价格清单 

onlineprice = preprocessing.reshape_data(pathway=pathway_0) 

  

# 注意 真实数据集这里sheet_number应该为1 

reshape_df = preprocessing.excelread(pathway_0, sheet_number=1) 

df_X, df_Z = preprocessing.dataconnection( 

    df_c=reshape_df, online_pirce_c=onlineprice) 

  

  

  

之后会调用三种模型进行拟合。简单来说，我们会根据现有的训练数据，计算出一些参数，根据这些模型参数，我们可以得到任意一笔交易对应的预测采购价格。  

  

每部分模型训练完成将在终端打印提示。拟合完成后，您将得到三个文件夹和对应的模型参数，文件夹内为该算法下的预测价格和相关信息。文件命名格式中包含运行的现实时间，可以快速检索您需要的文件输出。 

 

  

RFD和LGBM是决策树相关的模型，输出结果请在/RFD文件夹下查阅  

 # 决策树部分 

RFD = RF_Detection() 

RFD.fit(df_X, df_Z) 

scoreX = RFD.score('X') 

scoreZ = RFD.score('Z') 

print(scoreX, scoreZ) 

RFD_result = RFD.statistical_analysis(save=True) 

  

print('RFD is okay!') 

  

LGBM = LightGBM_Detection() 

LGBM.fit(df_X, df_Z) 

LGBM_result = LGBM.statistical_analysis(save=True) 

  

print('LGBM is okay!') 

您应该会在该文件夹下得到如下信息 

 

  

MR是多元线性回归模型，结果请在/MR下查阅  

 Xi_x, Xi_y,  Xi_dingdan, Xi_model = MR.regression(df_X, 'X', time0) 

Zhong_x, Zhong_y, Zhong_dingdan, Zhong_model = MR.regression(df_Z, 'Z', time0) 

  

您应该得到如下信息 

 

  

  

AE是autoencoder神经网络，结果请在/AE下查阅  

  

预测数据请保证它的格式和训练数据统一，且每一个列标签都已经在训练集中出现，否则会因为该参数未找到显示错误。  

  

最后我们会对输出结果进行整合，请参考/Output文件夹。 您应该得到包括ID，分数score，四个计算误差参数的表格。其中leverage为杠杆值，SR为学生化残差，cook是库克距离。为方便理解，请将score从大到小排序，score分数越高，这项交易越有可能是异常值。现阶段，为方便理解，我们只判断标准差是否大于2，如果超过，则认为是异常值，决策树算法和线性回归算法分别提供0或者1点分数。您可以在Integration_output.py的line 18-20修改标准差阈值，一般来说，如果数据是无异常的，那么标准差在3以内的数据会包含99.7%(正态分布理论)。所以如果score=2的条例过多，可以尝试修改阈值从2到3。 

 

 

在代码运行完毕之后，您应该会在终端或者交互式窗口得到一份输出，这是线性回归算法的评价图，例如：其中R-squared是评价整个数据集拟合效果的参数，请保留截图（此处由于我们对数据采购价格做了全随机，因此R-squared分数会很低）。  

 

 

 

结果分析 

 

从最简化的方法来说，您只需要观看/Output文件夹下文件中score的具体值以及autoencoder的…，score值由多元线性回归算法和决策树算法共同组成，当score不为0的时候，意味着至少有一个算法认为该项交易是异常的。 

进一步考虑，请将/Output文件中SR_MR或SR_RFD进行排序，这两项值分别是线性回归和决策树的标准差。当这项标准差的绝对值越大，意味着这项交易的采购价格越有可能是异常的。当该绝对值超过3时，一定为异常数据。超过2时，有较大概率。在1以下，基本不会是异常。同时，您可以将leverage和cook进行排序，leverage的判断方法和标准差一致，当超过3时，存在异常，但此处并不是价格异常，而是偏向于采购数量等输入因素有异常。例如在A医院对B药品的采购一般是10-20单位，但有一项交易显示为1000单位，那么它的leverage就会超过3显示异常。Cook距离值越大，意味着该项交易影响程度越大，也越可能是异常。 

注意，我们的算法目前仅为测试采购价格异常，最终效果并不一定能够得到保证，算法的效果非常依赖于数据集本身。有可能会根据您输入数据集的大小不同，出现以下情况，如果效果不佳，还请不用紧张： 

R-squared值非常低，这意味着线性回归的模型效果不佳，具体原因未知 

决策树和多元线性回归算法的结果相差很大，这意味着可能存在过拟合等问题 

Score分数不为0的部分非常少，意味着理论得出的异常交易很少 

有一些其他限制条件没有加入到我们的函数中来，例如先前提到的价格限制范围等，这部分可能会产生其他潜在问题。 

 

Autoencoder部分，因为autoencoder和其他两种算法不同，它是非监督模型，所以输出结果有所变化。 

在autoencoder中，输入数据是对源数据中的数据进行摘取，并转换为独热编码格式（既保留原始的numberical数据，将非numberical的数据进行numberical转换），将所有的输入数据转换为autoencoder可以理解的的数值形式。输出数据的格式与输入数据是完全相同的，除了列名全都是数值的格式。但是可以将输出后的纯数字格式的数据通过index的形式转换回独热编码之前的格式，既摘取源数据中的那些列。以下是一个图示化的说明。 

 

所以，模型的输出数据与进行独热编码操作之后的数据是完全一样的的格式，在模型运行结束之后，利用index在输出后的数据中找回名为“筛选后的数据”中的这一整条数据，然后可以将所有的数据输出出来。但是在autoencoder中，并没有“自带”的检测模型拟合效果的函数，所以对重构后的数据进行筛选，在这里，使用了高斯分布（正态分布）来对异常的数据进行分类，将不在设定分布范围内的数据视为异常数据，每一条异常的数据都会被写入。 

综上所述，最终的输出的数据的格式将会是上图中名为“筛选后的数据”的格式，里面包含药品编码和医院等级等信息，可以指向源数据中的信息。目前我们已经做到能够找回源数据中的部分信息，但是通过index的方法，可以实现将异常的交易的所有信息直接输出出来。总结起来就是：我的目标是在模型运行之后，输出数据直接就是异常交易的所有信息。 

 

而在回归/决策树模型中，输入数据是原始的交易信息表格，模型会提取原始表格中的“药品标识码'， '类别码'， '名称码'， '剂型码'，'规格包装码'， '企业码'， '地市'， '医院等级'， '订单时间'， '采购价格'， '挂网价格'， '订单代码'，去除掉用作订单识别的‘订单代码’以及用作统计分析的’挂网价格’后，其余数据经过独热编码后用作训练特征。经过训练之后，模型会对中药和西药的数据分别预测其采购价格，随后与挂网价格以及实际的采购价格进行比较。统计结果表格包含了订单号码，方便用户找到具体的异常订单。 

 

 

 

五、  需求 

 

1. 对于我们的算法来说，最好的输入是有明确的异常检测标签，例如我的输入数据是10条，其中0代表非异常数据，1代表异常数据，它们的标签是[0,0,0,1,0,0,0,0,1,1], 如果有这样子的具体标签，将会极大幅度地优化我们算法的效率和结果。但由于数据集本身庞大，人工审查并不现实，因此我们建议先通过目前算法的预测价格，筛选出最有可能是异常交易的一批数据，然后再进行校对。  

2. 更多边界条件，因为我们输入的数据多为字符串类型，在独热编码扩充之后列标签过多，很有可能影响运行的时长，在终端输出中您可以看到每一部分的运行时间，如果能有更多数值型变量，或者其他一些限制条件，能更好地完善我们的模型。 

3.远程操作申请，在数据集本身去敏的情况下，我们进行数据操作有很大隐患和不便。如果可以进行远程操作，我认为可以尽可能保护数据集本身不外泄的同时，定向优化我们的算法。 

4.运行结果，此处重复我们希望得到的结果回馈。首先是生成的四个文件夹中的表格，表格数据只有订单号和原始价格是采自真实数据集，我们会保证不外泄相关数据。其次是终端的OLS输出，请截图保存。 

 

 

 

六、  未来建议 

 

对于我们的最终产出，我们有以下提议。 

1. 在算法部分，我们希望现阶段的实验结果是存在缺陷和问题的，这样能够使我们能有更多创新空间。如果效果已经可以，这说明数据集本身采纳的步骤是完备的，以后可以沿用当前数据采集的格式，这非常有价值。(人工检测是否异常部分，请务必认真审核，这也会影响到我们后面的数据训练) 

2. 我们希望最终可以制作一个系统出来，系统的主要形式是地图，在地图上我们可以检索特定药品，特定医院等级，特定路线等。根据检索要求返回该条件下的异常信息。用不同颜色标注出，更加直观。同时，我们希望这个系统可以展示特定条件下的药品价格变化曲线和趋势(后续可以加入采购时间变化趋势等等)的折线图，能够进行警示未来阶段是否会产生价格上升、配送困难等问题。这部分工作可以的话，希望能够在所有异常检测完毕之后进行考虑。 

 
